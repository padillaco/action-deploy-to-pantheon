name: 'Deploy to Pantheon'
description: 'Deploys local GitHub repo to Pantheon using action-deploy-to-remote-repository and Pantheon terminus.'
author: 'padillaco'
branding:
  icon: 'cloud-lightning'
  color: 'yellow'
inputs:
  # Upstream action-deploy-to-remote-repository inputs
  base_directory:
    description: 'Base directory for rsync'
    required: false
  destination_directory:
    description: 'Destination directory for rsync in remote repository'
    required: false
  exclude_list:
    description: 'Comma-separated list of files and directories to exclude from sync'
    required: false
    default: '.git, .github, .gitmodules, node_modules'
  ssh_key:
    description: 'SSH key to use for remote repository authentication.'
    required: true
  # Pantheon-specific inputs
  pantheon_site:
    description: 'Name of Pantheon site to deploy to.'
    required: true
  pantheon_site_id:
    description: 'Pantheon site ID to deploy to.'
    required: true
  pantheon_machine_token:
    description: 'Pantheon machine token to use.'
    required: true
  terminus_version:
    description: 'Version of terminus to use.'
    default: '3.3.0'

runs:
  using: 'composite'
  steps:
    - name: Parse Branch Name (Base)
      shell: bash
      env:
        BRANCH: ${{ github.ref_name }}
      id: branch-name-base
      run: echo "branch_name_base=$(echo BRANCH | cut -d '/' -f1)" >> $GITHUB_OUTPUT
    - name: Parse Branch Name (Fragment)
      shell: bash
      env:
        BRANCH: ${{ github.ref_name }}
      id: branch-name-fragment
      run: echo "branch_name_fragment=$(echo BRANCH | cut -d '/' -f2)" >> $GITHUB_OUTPUT
    - name: Sync to Pantheon
      uses: padillaco/action-deploy-to-remote-repository@main
      with:
        remote_repo: 'ssh://codeserver.dev.${{ inputs.pantheon_site_id }}@codeserver.dev.${{ inputs.pantheon_site_id }}.drush.in:2222/~/repository.git'
        base_directory: ${{ inputs.base_directory }}
        destination_directory: ${{ inputs.destination_directory }}
        exclude_list: ${{ inputs.exclude_list }}
        ssh_key: ${{ inputs.ssh_key }}
        remote_branch: ${{ (github.ref_name == 'dev' || github.ref_name == 'staging' || github.ref_name == 'main') && 'master' || steps.branch-name-fragment.outputs.branch_name_fragment }}
    - name: Install terminus
      shell: bash
      run: |
        mkdir -p /tmp/terminus && cd /tmp/terminus
        curl -L "https://github.com/pantheon-systems/terminus/releases/download/${{ inputs.terminus_version }}/terminus.phar" --output terminus
        chmod +x terminus
        sudo mv terminus /usr/local/bin/terminus
    - name: Authenticate with Terminus
      shell: bash
      run: terminus auth:login --machine-token=${{ inputs.pantheon_machine_token }}
    - name: "Deploy to Pantheon multidev environment"
      if: ${{ steps.branch-name-fragment.outputs.branch_name_base == 'multidev' }}
      shell: bash
      run: |
        echo "Deploying ${{ github.ref_name }} to multidev environment."
        terminus env:deploy ${{ inputs.pantheon_site }}.${{ steps.branch-name-fragment.outputs.branch_name_fragment }} --note="$(git log -1 --pretty=%B)"
    - name: "Deploy to Pantheon dev environment"
      if: ${{ github.ref_name == 'develop' }}
      shell: bash
      run: |
        echo "Deploying to dev environment."
        terminus env:deploy ${{ inputs.pantheon_site }}.dev --note="$(git log -1 --pretty=%B)"
    - name: Autopromote dev to test
      if: ${{ github.ref_name == 'staging' }}
      shell: bash
      run: |
        echo "Autopromoting dev to test."
        terminus env:deploy ${{ inputs.pantheon_site }}.test --note="$(git log -1 --pretty=%B)"
    - name: Autopromote test to live
      if: ${{ github.ref_name == 'main' }}
      shell: bash
      run: |
        echo "Autopromoting test to live."
        terminus env:deploy ${{ inputs.pantheon_site }}.live --note="$(git log -1 --pretty=%B)"
